{% extends 'base.html' %}

{% block title %}Update Attendance - Staff Dashboard{% endblock %}



{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title mb-0">Update Attendance</h1>
</div>

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">Class/Course <span class="text-danger">*</span></label>
                <select name="course" class="form-select form-control-modern" id="course">
                    <option value="">Select Class/Course</option>
                    {% for course in courses %}
                    <option value="{{ course.id }}">{{ course.name }}</option>
                    {% endfor %}
                </select>
            </div>

        </div>
        <div class="text-end">
            <button type="button" class="btn btn-modern btn-gradient-primary" id="fetch_attendance">Fetch Attendance
                Dates</button>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm mb-4" id="attendance_block" style="display:none;">
    <div class="card-body p-4">
        <div class="mb-3">
            <label class="form-label fw-bold">Attendance Date <span class="text-danger">*</span></label>
            <select name="attendance_date" class="form-select form-control-modern" id="attendance_date">
                <!-- Options loaded via AJAX -->
            </select>
        </div>
        <div class="text-end">
            <button type="button" class="btn btn-modern btn-gradient-info" id="fetch_student_data">Fetch Student
                Data</button>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm" id="student_data_card" style="display:none;">
    <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">Student Attendance</h5>
    </div>
    <div class="card-body p-4">
        <div class="table-responsive" id="student_table_block">
            <!-- Student data will be loaded here -->
        </div>
        <div class="text-end mt-4">
            <button type="button" class="btn btn-modern btn-gradient-success" id="save_attendance">Update
                Attendance</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {

        // 1. Fetch Attendance Dates
        $("#fetch_attendance").click(function () {
            var course = $("#course").val();
            if (course == "") {
                alert("Please select course");
                return;
            }

            $.ajax({
                url: "{% url 'get_attendance_dates' %}",
                type: 'POST',
                data: { course_id: course },
            })
                .done(function (response) {
                    var json_data = JSON.parse(response);
                    if (json_data.length > 0) {
                        var html_data = "";
                        for (key in json_data) {
                            html_data += "<option value='" + json_data[key]["id"] + "'>" + json_data[key]["attendance_date"] + "</option>";
                        }
                        $("#attendance_date").html(html_data);
                        $("#attendance_block").show();
                        $("#student_data_card").hide();
                    }
                    else {
                        alert("No Attendance Data Found");
                        $("#attendance_block").hide();
                        $("#student_data_card").hide();
                    }
                })
                .fail(function () {
                    alert("Error in Fetching Attendance Dates");
                })
        })

        // 2. Fetch Student Data for selected Attendance ID
        $("#fetch_student_data").click(function () {
            var attendance_date = $("#attendance_date option:selected").val(); // This is the ID of attendance record

            $.ajax({
                url: "{% url 'get_attendance_student' %}",
                type: 'POST',
                data: { attendance_date: $("#attendance_date option:selected").text(), attendance_id: attendance_date },
            })
                .done(function (response) {
                    var json_data = JSON.parse(response);
                    var json_data = JSON.parse(response);
                    var div_data = "<div class='table-responsive'><table class='table table-hover'><thead><tr><th>Student Name</th><th>Attendance</th><th>Leave Status</th></tr></thead><tbody>";

                    for (key in json_data) {
                        div_data += "<tr><td>" + json_data[key].name + "</td>";
                        div_data += "<td><div class='form-check'><input type='checkbox' name='student_data[]' value='" + json_data[key].id + "' class='form-check-input attendance_checkbox' id='checkbox_" + json_data[key].id + "'";

                        if (json_data[key].status) {
                            div_data += " checked='checked'";
                        }
                        div_data += "><label class='form-check-label' for='checkbox_" + json_data[key].id + "'>Present</label></div></td>";

                        var displayStyle = json_data[key].status ? 'none' : 'block';
                        var informedSelected = (json_data[key].leave_status == 'Informed') ? 'selected' : '';
                        var notInformedSelected = (json_data[key].leave_status == 'Not Informed') ? 'selected' : '';

                        div_data += "<td><select class='form-select form-control-sm leave_status_select' id='leave_" + json_data[key].id + "' style='display:" + displayStyle + ";'><option value=''>-- Select --</option><option value='Informed' " + informedSelected + ">Informed</option><option value='Not Informed' " + notInformedSelected + ">Not Informed</option></select></td></tr>";
                    }
                    div_data += "</tbody></table></div>";
                    $("#student_data_card").show();
                    $("#student_table_block").html(div_data);

                    // Add event listener for checkboxes
                    $(".attendance_checkbox").change(function () {
                        var student_id = $(this).val();
                        if ($(this).is(":checked")) {
                            $("#leave_" + student_id).hide();
                        } else {
                            $("#leave_" + student_id).show();
                        }
                    });
                })
                .fail(function () {
                    alert("Error in Fetching Student Data");
                })
        })

        // 3. Save Updated Attendance
        $("#save_attendance").click(function () {
            var student_data = [];
            $("input[name='student_data[]']").each(function () {
                var student_id = $(this).val();
                var status = 0;
                var leave_status = "";

                if ($(this).is(":checked")) {
                    status = 1;
                } else {
                    status = 0;
                    leave_status = $("#leave_" + student_id).val();
                }

                student_data.push({
                    id: student_id,
                    status: status,
                    leave_status: leave_status
                });
            });

            var attendance_date = $("#attendance_date option:selected").text();
            var attendance_id = $("#attendance_date").val();

            student_data = JSON.stringify(student_data);

            $.ajax({
                url: "{% url 'save_updateattendance_data' %}",
                type: 'POST',
                data: {
                    student_ids: student_data,
                    attendance_date: attendance_date,
                    attendance_id: attendance_id
                },
            })
                .done(function (response) {
                    if (response == "OK") {
                        alert("Attendance Updated Successfully");
                        location.reload();
                    }
                    else {
                        alert("Error Updating Attendance: " + response);
                    }
                })
                .fail(function () {
                    alert("Error in Updating Attendance");
                })
        })
    })
</script>
{% endblock %}