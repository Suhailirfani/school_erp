{% extends 'base.html' %}

{% block title %}Take Attendance - HOD Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title mb-0">Take Attendance</h1>
</div>

<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">Class/Course <span class="text-danger">*</span></label>
                <select name="course" class="form-select form-control-modern" id="course">
                    <option value="">Select Class/Course</option>
                    {% for course in courses %}
                    <option value="{{ course.id }}">{{ course.name }}</option>
                    {% endfor %}
                </select>
            </div>

        </div>
        <div class="text-end mt-4">
            <button type="button" class="btn btn-modern btn-gradient-primary" id="fetch_student">Fetch Students</button>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm" id="student_data_card" style="display:none;">
    <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">Student Attendance</h5>
    </div>
    <div class="card-body p-4">
        <div class="mb-3">
            <label class="form-label fw-bold">Attendance Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control form-control-modern" id="attendance_date" name="attendance_date">
        </div>

        <div class="table-responsive" id="student_table_block">
            <!-- Student data will be loaded here -->
        </div>

        <div class="text-end mt-4">
            <button type="button" class="btn btn-modern btn-gradient-success" id="save_attendance">Save
                Attendance</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        // Set default date to today
        var today = new Date().toISOString().split('T')[0];
        document.getElementById("attendance_date").value = today;

        $("#fetch_student").click(function () {
            var course = $("#course").val();
            if (course == "") {
                alert("Please select course");
                return;
            }

            $.ajax({
                url: "{% url 'admin_get_students_attendance' %}",
                type: 'POST',
                data: { course_id: course },
            })
                .done(function (response) {
                    var json_data = JSON.parse(response);
                    if (json_data.length > 0) {
                        var div_data = "<div class='table-responsive'><table class='table table-hover'><thead><tr><th>Student Name</th><th>Attendance</th><th>Leave Status</th></tr></thead><tbody>";

                        for (key in json_data) {
                            div_data += "<tr><td>" + json_data[key]["name"] + "</td>";
                            div_data += "<td><div class='form-check'><input type='checkbox' checked='checked' name='student_data[]' value='" + json_data[key]["id"] + "' class='form-check-input attendance_checkbox' id='checkbox_" + json_data[key]["id"] + "'><label class='form-check-label' for='checkbox_" + json_data[key]["id"] + "'>Present</label></div></td>";
                            div_data += "<td><select class='form-select form-control-sm leave_status_select' id='leave_" + json_data[key]["id"] + "' style='display:none;'><option value=''>-- Select --</option><option value='Informed'>Informed</option><option value='Not Informed'>Not Informed</option></select></td></tr>";
                        }
                        div_data += "</tbody></table></div>";
                        $("#student_data_card").show();
                        $("#student_table_block").html(div_data);

                        // Add event listener for checkboxes
                        $(".attendance_checkbox").change(function () {
                            var student_id = $(this).val();
                            if ($(this).is(":checked")) {
                                $("#leave_" + student_id).hide();
                            } else {
                                $("#leave_" + student_id).show();
                            }
                        });
                    }
                    else {
                        $("#student_data_card").hide();
                        $("#student_table_block").html("");
                        alert("No Students Found For Selected Criteria");
                    }
                })
                .fail(function () {
                    alert("Error in Fetching Student");
                })
        })

        $("#save_attendance").click(function () {
            var student_data = [];
            $("input[name='student_data[]']").each(function () {
                var student_id = $(this).val();
                var status = 0;
                var leave_status = "";

                if ($(this).is(":checked")) {
                    status = 1;
                } else {
                    status = 0;
                    leave_status = $("#leave_" + student_id).val();
                }

                student_data.push({
                    id: student_id,
                    status: status,
                    leave_status: leave_status
                });
            });

            var attendance_date = $("#attendance_date").val();
            var course_id = $("#course").val();

            if (attendance_date == "") {
                alert("Please Select Date");
                return;
            }

            student_data = JSON.stringify(student_data);

            $.ajax({
                url: "{% url 'admin_save_attendance_data' %}",
                type: 'POST',
                data: {
                    student_ids: student_data,
                    attendance_date: attendance_date,
                    course_id: course_id,
                },
            })
                .done(function (response) {
                    if (response == "OK") {
                        alert("Attendance Saved");
                        location.reload();
                    }
                    else {
                        alert("Error Saving Attendance: " + response);
                    }
                })
                .fail(function () {
                    alert("Error in Saving Attendance");
                })
        })
    })
</script>
{% endblock %}